<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CRUCIAL: Updated viewport meta for full mobile compatibility -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Dashboard [LIVE]</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Chart.js (for our gauges and charts) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 3. Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 4. NEW: Load Paho MQTT Client (for connecting) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    
    <style>
        /* Use a clean, modern font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        
        /* Updated chart-label size for better mobile/desktop scaling */
        .chart-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.75rem; /* ~28px on mobile */
            font-weight: 600;
        }
        @media (min-width: 768px) {
            .chart-label {
                font-size: 2.5rem; /* 40px on desktop */
            }
        }
        
        .card {
            background-color: #ffffff; /* white */
        }
        
        .pulse-red {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: #EF4444; } /* red-500 */
            50% { background-color: #DC2626; } /* red-600 */
        }

        .btn-chart-active {
            background-color: #2563EB; /* bg-blue-600 */
            color: white !important;
        }
        .btn-chart {
            color: #334155; /* text-slate-700 */
        }
        .btn-chart:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        
        .pulse-yellow {
            animation: pulse-yellow 1.5s infinite;
        }
        @keyframes pulse-yellow {
            0%, 100% { background-color: #F59E0B; } /* yellow-500 */
            50% { background-color: #D97706; } /* yellow-600 */
        }
        
        #toast {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .nav-link-active {
            background-color: #eff6ff; /* bg-blue-50 */
            color: #2563EB; /* text-blue-600 */
            font-weight: 600;
        }
        .nav-link:hover {
             background-color: #f8fafc; /* bg-slate-50 */
        }

        .pulse-shadow-red {
             animation: pulse-shadow-red 1.5s infinite;
        }
        @keyframes pulse-shadow-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Toggle Switch styles */
        .toggle-checkbox:checked + .toggle-label {
            background-color: #2563EB; /* bg-blue-600 */
            border-color: #2563EB; /* border-blue-600 */
        }
        .toggle-checkbox:checked + .toggle-label .toggle-circle {
            transform: translateX(16px); /* 16px = 4 units (w-10 - w-6) */
            border-color: #2563EB; 
        }
        .toggle-circle {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-label {
            transition: all 0.2s ease-in-out;
        }

        /* FIX: GLOBAL Chart Height Constraint for MOBILE/General View */
        #liveHistoryChart, #historicalChart {
            max-height: 250px; /* Reduced max height for better mobile viewing */
        }
        @media (min-width: 1024px) {
            #liveHistoryChart, #historicalChart {
                max-height: 300px; /* Slightly taller for compact desktop view */
            }
        }
    </style>
</head>
<body class="text-slate-800 bg-slate-100 min-h-screen">

    <!-- Mobile Menu Overlay (Click to close menu) -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300 opacity-0 lg:hidden"></div>

    <!-- Main Layout Wrapper -->
    <div class="flex min-h-screen">
        
        <!-- Responsive Sidebar (Hidden on mobile, slides in/out) -->
        <aside id="mobile-sidebar" class="w-64 bg-white shadow-xl flex flex-col h-full fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50">
            <!-- Sidebar Header -->
            <div class="p-6 flex items-center space-x-3 border-b border-slate-200 flex-shrink-0">
                <i data-lucide="layout-dashboard" class="text-blue-600"></i>
                <span class="text-xl font-bold text-slate-800">Smart Home</span>
                <!-- Close Button for Mobile -->
                <button id="close-menu-btn" class="lg:hidden ml-auto p-1 rounded-full text-slate-500 hover:bg-slate-100 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Navigation -->
            <nav id="sidebar-nav" class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#dashboard" class="nav-link nav-link-active flex items-center space-x-3 px-4 py-2 rounded-lg text-slate-700">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#devices" class="nav-link flex items-center space-x-3 px-4 py-2 rounded-lg text-slate-700">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                    <span>Devices</span>
                </a>
                <a href="#history" class="nav-link flex items-center space-x-3 px-4 py-2 rounded-lg text-slate-700">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span>History</span>
                </a>
                <a href="#settings" class="nav-link flex items-center space-x-3 px-4 py-2 rounded-lg text-slate-700">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span>Settings</span>
                </a>
            </nav>
            
            <!-- Permanent Status Footer (Always Visible) -->
            <div class="p-4 border-t border-slate-200 flex-shrink-0">
                <h3 class="text-xs font-semibold text-slate-400 uppercase mb-2">System Status</h3>
                
                <!-- Connection Status -->
                <div class="flex items-center justify-between text-sm">
                    <span class="text-slate-500">Connection:</span>
                    <div class="flex items-center space-x-2">
                        <span id="conn-text" class="text-slate-600 font-medium">Connecting...</span>
                        <span id="conn-status" class="w-3 h-3 inline-block rounded-full" title="Connecting..."></span>
                    </div>
                </div>
                
                <!-- Device Status -->
                <div class="flex items-center justify-between text-sm mt-2">
                    <span class="text-slate-500">Device (Living Room):</span>
                    <div class="flex items-center space-x-2">
                        <span id="device-status-text" class="font-semibold text-slate-600">--</span>
                        <span id="device-status-dot" class="w-3 h-3 inline-block rounded-full bg-slate-400" title="Status"></span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area (with responsive offset for sidebar) -->
        <main class="flex-1 w-full lg:ml-64 min-h-screen">
            
            <!-- Page 1: Dashboard (Default Visible) -->
            <div id="page-dashboard" class="page">
                <!-- Responsive Header for main content -->
                <div class="p-4 sm:p-6 border-b border-slate-200 bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex items-center">
                         <!-- Mobile Menu Button -->
                        <button id="mobile-menu-btn" class="lg:hidden mr-4 p-2 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Living Room Dashboard</h1>
                    </div>
                </div>

                <!-- Dashboard Grid (inside main content) -->
                <!-- Grid changed to always use 1 column on mobile (default) for large charts -->
                <div class="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- Card: Temperature Gauge -->
                    <div class="card rounded-lg shadow-md p-6 relative">
                        <h2 class="text-lg font-semibold text-slate-500 text-center mb-4">Live Temperature</h2>
                        <!-- Full width canvas on mobile forces chart size -->
                        <div class="w-full max-w-sm mx-auto">
                            <canvas id="tempGauge"></canvas>
                            <div id="temp-label" class="chart-label text-blue-600">-- °C</div>
                        </div>
                        
                        <div class="flex justify-between text-sm text-slate-500 px-4 mt-4">
                            <span class="text-center">
                                Min (24h):
                                <strong id="gauge-min-temp" class="block text-slate-700 font-semibold">-- °C</strong>
                            </span>
                            <span class="text-center">
                                Max (24h):
                                <strong id="gauge-max-temp" class="block text-slate-700 font-semibold">-- °C</strong>
                            </span>
                        </div>
                    </div>

                    <!-- Card: Humidity Gauge -->
                    <div class="card rounded-lg shadow-md p-6 relative">
                        <h2 class="text-lg font-semibold text-slate-500 text-center mb-4">Live Humidity</h2>
                        <!-- Full width canvas on mobile forces chart size -->
                        <div class="w-full max-w-sm mx-auto">
                            <canvas id="humidityGauge"></canvas>
                            <div id="hum-label" class="chart-label text-green-600">-- %</div>
                        </div>
                        
                        <div class="flex justify-between text-sm text-slate-500 px-4 mt-4">
                            <span class="text-center">
                                Min (24h):
                                <strong id="gauge-min-hum" class="block text-slate-700 font-semibold">-- %</strong>
                            </span>
                            <span class="text-center">
                                Max (24h):
                                <strong id="gauge-max-hum" class="block text-slate-700 font-semibold">-- %</strong>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Card: Quick Stats -->
                    <!-- Takes full width on mobile, and 1/2 or 1/3 on larger screens -->
                    <div class="card rounded-lg shadow-md p-6 lg:col-span-1 md:col-span-2">
                        <h2 class="text-lg font-semibold text-slate-500 mb-4 flex items-center"><i data-lucide="thermometer" class="w-5 h-5 mr-2"></i>Quick Stats (24h)</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-sm text-slate-500">Current Temp</span>
                                <span id="stat-temp" class="text-lg font-bold text-blue-600 block">--</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="text-sm text-slate-500">Current Humi</span>
                                <span id="stat-hum" class="text-lg font-bold text-green-600 block">--</span>
                            </div>
                            <div class="flex justify-between pt-2">
                                <span class="text-sm text-slate-500">Max Temp</span>
                                <span id="max-temp" class="text-lg font-semibold text-slate-700 block">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-slate-500">Min Temp</span>
                                <span id="min-temp" class="text-lg font-semibold text-slate-700 block">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Live History Chart (Full width on all screens) -->
                    <div class="card rounded-lg shadow-md p-6 md:col-span-full lg:col-span-3">
                        <h2 class="text-lg font-semibold text-slate-500 mb-4">Live Sensor History</h2>
                        <canvas id="liveHistoryChart"></canvas>
                    </div>

                </div>
            </div> <!-- End Page 1: Dashboard -->

            <!-- Page 2: Devices (Hidden by default) -->
            <div id="page-devices" class="page hidden">
                <!-- Header -->
                <div class="p-4 sm:p-6 border-b border-slate-200 bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex justify-between items-center">
                        <!-- Mobile Menu Button -->
                        <button id="mobile-menu-btn-devices" class="lg:hidden mr-4 p-2 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800 flex-1">Device Management</h1>
                        <button id="add-device-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center space-x-2 transition-all text-sm">
                            <i data-lucide="plus" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                            <span class="hidden sm:inline">Add Device</span>
                        </button>
                    </div>
                </div>
                
                <!-- Device Grid (Responsive: 1 column on mobile, 2 on desktop) -->
                <div class="p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Device Card: Living Room (Live) -->
                    <div id="device-card-livingroom" class="card rounded-lg shadow-md p-6 transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="home" class="w-6 h-6 text-blue-500"></i>
                                <h2 class="text-xl font-semibold text-slate-700">Living Room Sensor</h2>
                            </div>
                            <span id="device-card-status-dot" class="w-3 h-3 rounded-full bg-slate-400 mt-2" title="Status"></span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-500">Status</span>
                                <span id="device-card-status-text" class="font-semibold text-slate-600">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Temperature</span>
                                <span id="device-card-temp" class="font-semibold text-slate-600">-- °C</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Humidity</span>
                                <span id="device-card-hum" class="font-semibold text-slate-600">-- %</span>
                            </div>
                        </div>
                        <!-- Mute Button (appears on alert) -->
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <button id="device-card-mute-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center space-x-2 transition-all text-sm w-full justify-center" title="Mute Buzzer">
                                <i data-lucide="bell-off" class="w-4 h-4"></i>
                                <span>Mute Buzzer</span>
                            </button>
                        </div>
                    </div>

                    <!-- Device Card: Kitchen (Sample) -->
                    <div class="card rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="chef-hat" class="w-6 h-6 text-green-500"></i>
                                <h2 class="text-xl font-semibold text-slate-700">Kitchen Smart Plug</h2>
                            </div>
                            <span class="w-3 h-3 rounded-full bg-green-500 mt-2" title="Online"></span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-500">Status</span>
                                <span class="font-semibold text-green-600">Online</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Power Usage</span>
                                <span class="font-semibold text-slate-600">45 W</span>
                            </div>
                        </div>
                        <!-- Simulated Toggle -->
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-slate-700">Toggle Power</span>
                                <div class="relative inline-block w-10 align-middle">
                                    <input type="checkbox" name="toggle" id="toggle-kitchen" class="toggle-checkbox absolute opacity-0 w-0 h-0"/>
                                    <label for="toggle-kitchen" class="toggle-label block h-6 w-10 rounded-full bg-gray-300 cursor-pointer transition-colors duration-200 ease-in-out">
                                        <span class="toggle-circle absolute left-0 top-0 w-6 h-6 rounded-full bg-white border-4 border-gray-300 shadow transform transition-transform duration-200 ease-in-out"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Device Card: Bedroom (Sample) -->
                    <div class="card rounded-lg shadow-md p-6 opacity-60">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="bed" class="w-6 h-6 text-slate-400"></i>
                                <h2 class="text-xl font-semibold text-slate-700">Bedroom Sensor</h2>
                            </div>
                            <span class="w-3 h-3 rounded-full bg-slate-400 mt-2" title="Offline"></span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-slate-500">Status</span>
                                <span class="font-semibold text-slate-500">Offline</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Temperature</span>
                                <span class="font-semibold text-slate-500">-- °C</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Humidity</span>
                                <span class="font-semibold text-slate-500">-- %</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div> <!-- End Page 2: Devices -->

            <!-- Page 3: History (Hidden by default) -->
            <div id="page-history" class="page hidden">
                <div class="p-4 sm:p-6 border-b border-slate-200 bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex items-center">
                        <!-- Mobile Menu Button -->
                        <button id="mobile-menu-btn-history" class="lg:hidden mr-4 p-2 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800">History & Analytics</h1>
                    </div>
                </div>
                <!-- Interactive Historical Chart (MOVED HERE) -->
                <div class="p-4 sm:p-6">
                    <div class="card rounded-lg shadow-md p-6">
                        <!-- Responsive button layout: stack on small, row on larger screens -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <h2 class="text-lg font-semibold text-slate-500 mb-3 sm:mb-0">Historical Data</h2>
                            <div id="chart-buttons" class="flex space-x-1 bg-slate-200 p-1 rounded-lg w-full sm:w-auto justify-stretch">
                                <button class="btn-chart flex-1 px-3 py-1 text-sm font-medium rounded-md" data-range="hour">Hour</button>
                                <button class="btn-chart flex-1 px-3 py-1 text-sm font-medium rounded-md" data-range="day">Day</button>
                                <button class="btn-chart flex-1 px-3 py-1 text-sm font-medium rounded-md" data-range="month">Month</button>
                                <button class="btn-chart flex-1 px-3 py-1 text-sm font-medium rounded-md" data-range="year">Year</button>
                            </div>
                        </div>
                        <!-- Full width canvas on mobile for large chart -->
                        <canvas id="historicalChart"></canvas>
                    </div>
                </div>
            </div> <!-- End Page 3: History -->
            
            <!-- Page 4: Settings (Hidden by default) -->
            <div id="page-settings" class="page hidden">
                <div class="p-4 sm:p-6 border-b border-slate-200 bg-white shadow-sm sticky top-0 z-10">
                    <div class="flex items-center">
                        <!-- Mobile Menu Button -->
                        <button id="mobile-menu-btn-settings" class="lg:hidden mr-4 p-2 rounded-lg text-slate-700 hover:bg-slate-100 transition-colors">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Settings</h1>
                    </div>
                </div>
                
                <div class="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Card: Alert Thresholds -->
                    <div class="card rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-slate-700 mb-4">Alert Thresholds</h2>
                        <div class="space-y-4">
                            <!-- Max Temp Slider -->
                            <div>
                                <label for="max-temp-slider" class="flex justify-between text-sm font-medium text-slate-600">
                                    <span>Max Temperature</span>
                                    <span id="max-temp-val" class="font-bold">26.0°C</span>
                                </label>
                                <input id="max-temp-slider" type="range" min="20" max="40" step="0.5" class="w-full mt-1 accent-blue-600">
                            </div>
                            <!-- Min Temp Slider -->
                            <div>
                                <label for="min-temp-slider" class="flex justify-between text-sm font-medium text-slate-600">
                                    <span>Min Temperature</span>
                                    <span id="min-temp-val" class="font-bold">18.0°C</span>
                                </label>
                                <input id="min-temp-slider" type="range" min="10" max="25" step="0.5" class="w-full mt-1 accent-blue-600">
                            </div>
                            <!-- Max Humi Slider -->
                            <div>
                                <label for="max-humi-slider" class="flex justify-between text-sm font-medium text-slate-600">
                                    <span>Max Humidity</span>
                                    <span id="max-humi-val" class="font-bold">60.0%</span>
                                </label>
                                <input id="max-humi-slider" type="range" min="40" max="80" step="1" class="w-full mt-1 accent-green-600">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card: Notifications -->
                    <div class="card rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-slate-700 mb-4">Notification Preferences</h2>
                        <div class="space-y-4">
                            <!-- Email Alerts -->
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-slate-700">Email Alerts</span>
                                <div class="relative inline-block w-10 align-middle">
                                    <input type="checkbox" name="toggle" id="toggle-email" class="toggle-checkbox absolute opacity-0 w-0 h-0"/>
                                    <label for="toggle-email" class="toggle-label block h-6 w-10 rounded-full bg-gray-300 cursor-pointer transition-colors duration-200 ease-in-out">
                                        <span class="toggle-circle absolute left-0 top-0 w-6 h-6 rounded-full bg-white border-4 border-gray-300 shadow transform transition-transform duration-200 ease-in-out"></span>
                                    </label>
                                </div>
                            </div>
                            <!-- Push Notifications -->
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-slate-700">Push Notifications</span>
                                <div class="relative inline-block w-10 align-middle">
                                    <input type="checkbox" name="toggle" id="toggle-push" class="toggle-checkbox absolute opacity-0 w-0 h-0" checked/>
                                    <label for="toggle-push" class="toggle-label block h-6 w-10 rounded-full bg-gray-300 cursor-pointer transition-colors duration-200 ease-in-out">
                                        <span class="toggle-circle absolute left-0 top-0 w-6 h-6 rounded-full bg-white border-4 border-gray-300 shadow transform transition-transform duration-200 ease-in-out"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="md:col-span-2">
                        <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center space-x-2 transition-all w-full justify-center shadow-lg hover:shadow-xl">
                            <i data-lucide="check" class="w-5 h-5"></i>
                            <span>Save All Settings</span>
                        </button>
                    </div>

                </div>
            </div> <!-- End Page 4: Settings -->

        </main>
    </div>
    
    <!-- Toast Notification element -->
    <div id="toast" class="fixed bottom-4 right-4 sm:bottom-10 sm:right-10 z-50 bg-blue-600 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-5">
        Toast message
    </div>


    <!-- 4. Main JavaScript Logic (The "Brain") -->
    <script>
        // --- Configuration (Matches your Arduino code) ---
        let MIN_TEMP = 18.0;
        let MAX_TEMP = 26.0;
        let MAX_HUMIDITY = 60.0;
        
        const MAX_LIVE_DATA_POINTS = 30; // How many points to show on the live history chart
        // --- End Configuration ---

        // Get all our HTML elements
        const connStatusDot = document.getElementById('conn-status');
        const connStatusText = document.getElementById('conn-text');
        
        // Sidebar status elements
        const deviceStatusDot = document.getElementById('device-status-dot');
        const deviceStatusText = document.getElementById('device-status-text');
        
        // Dashboard page elements
        const tempLabel = document.getElementById('temp-label');
        const humLabel = document.getElementById('hum-label');
        const statTempEl = document.getElementById('stat-temp');
        const statHumEl = document.getElementById('stat-hum');
        const maxTempEl = document.getElementById('max-temp');
        const minTempEl = document.getElementById('min-temp');
        const gaugeMinTempEl = document.getElementById('gauge-min-temp');
        const gaugeMaxTempEl = document.getElementById('gauge-max-temp');
        const gaugeMinHumEl = document.getElementById('gauge-min-hum');
        const gaugeMaxHumEl = document.getElementById('gauge-max-hum');
        
        // History Chart elements
        const chartButtonContainer = document.getElementById('chart-buttons');

        // Devices page elements
        const deviceCardLivingRoom = document.getElementById('device-card-livingroom');
        const deviceCardStatusDot = document.getElementById('device-card-status-dot');
        const deviceCardStatusText = document.getElementById('device-card-status-text');
        const deviceCardTemp = document.getElementById('device-card-temp');
        const deviceCardHum = document.getElementById('device-card-hum');
        const deviceCardMuteBtn = document.getElementById('device-card-mute-btn');
        
        // Other interactive elements
        const toast = document.getElementById('toast');
        const addDeviceBtn = document.getElementById('add-device-btn');
        const kitchenToggle = document.getElementById('toggle-kitchen');

        // Page navigation elements
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        
        // Settings Page Elements
        const maxTempSlider = document.getElementById('max-temp-slider');
        const minTempSlider = document.getElementById('min-temp-slider');
        const maxHumiSlider = document.getElementById('max-humi-slider');
        const maxTempVal = document.getElementById('max-temp-val');
        const minTempVal = document.getElementById('min-temp-val');
        const maxHumiVal = document.getElementById('max-humi-val');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const toggleEmail = document.getElementById('toggle-email');
        const togglePush = document.getElementById('toggle-push');
        
        // Mobile menu elements
        const mobileSidebar = document.getElementById('mobile-sidebar');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const mobileMenuButtons = document.querySelectorAll('[id^="mobile-menu-btn"]');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        
        // Min/Max tracking
        let maxTempToday = -Infinity;
        let minTempToday = Infinity;
        let maxHumToday = -Infinity;
        let minHumToday = Infinity;


        // --- Chart.js Global Defaults (Light Mode Only) ---
        function updateChartTheme() {
            const gridColor = '#e2e8f0'; // slate-200
            const tickColor = '#475569'; // slate-600
            const legendColor = '#334155'; // slate-700

            Chart.defaults.color = tickColor;
            Chart.defaults.borderColor = gridColor;

            // Update all charts
            Object.values(Chart.instances).forEach(chart => {
                // Update scales
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks.color = tickColor;
                    chart.options.scales.x.grid.color = gridColor;
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks.color = tickColor;
                    chart.options.scales.y.grid.color = gridColor;
                }
                if (chart.options.scales.yTemp) {
                    chart.options.scales.yTemp.ticks.color = '#3B82F6'; // Blue-500
                    chart.options.scales.yTemp.grid.color = gridColor;
                }
                 if (chart.options.scales.yHum) {
                    chart.options.scales.yHum.ticks.color = '#22C55E'; // Green-500
                }
                
                // Update legend
                if (chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = legendColor;
                }
                
                // Update gauge inactive color
                if (chart.config.type === 'doughnut') {
                    chart.config.data.datasets[0].backgroundColor[1] = '#e2e8f0'; // slate-200
                }

                chart.update('none');
            });
        }


        // --- Chart.js Gauge Config ---
        const createGaugeConfig = (color, maxVal) => ({
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, maxVal],
                    backgroundColor: [color, '#e2e8f0'], // Active, Inactive (slate-200)
                    borderWidth: 0,
                    circumference: 270, // 3/4 circle
                    rotation: 225, // Start at bottom-left
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1, // Changed to 1:1 aspect ratio for better mobile sizing
                cutout: '80%',
                animation: {
                    duration: 0 // No animation for live data
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });

        // --- Chart.js Live History Config ---
        const liveHistoryConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#3B82F6', // Blue-500
                        backgroundColor: '#3B82F633',
                        fill: false,
                        tension: 0.2
                    },
                    {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#22C55E', // Green-500
                        backgroundColor: '#22C55E33',
                        fill: false,
                        tension: 0.2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Allow chart to fill container height
                scales: {
                    x: {}, // Defaults will be applied by updateChartTheme
                    y: {}
                },
                plugins: {
                    legend: { labels: {} }
                },
                animation: {
                    duration: 200 // Faster update animation
                }
            }
        };

        // --- Historical Config ---
        const historicalConfig = {
            type: 'line', 
            data: {
                labels: [], 
                datasets: [
                    {
                        label: 'Avg Temperature (°C)',
                        data: [], 
                        borderColor: '#3B82F6',
                        backgroundColor: '#3B82F633',
                        fill: true,
                        tension: 0.2,
                        yAxisID: 'yTemp'
                    },
                    {
                        label: 'Avg Humidity (%)',
                        data: [], 
                        borderColor: '#22C55E',
                        backgroundColor: '#22C55E33',
                        fill: true,
                        tension: 0.2,
                        yAxisID: 'yHum'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Allow chart to fill container height
                scales: {
                    x: {},
                    yTemp: { 
                        type: 'linear',
                        position: 'left',
                        ticks: { callback: (value) => `${value}°C` },
                    },
                    yHum: { 
                        type: 'linear',
                        position: 'right',
                        ticks: { callback: (value) => `${value}%` },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { labels: {} }
                }
            }
        };

        // --- Initialize Charts ---
        const tempGauge = new Chart(document.getElementById('tempGauge'), createGaugeConfig('#3B82F6', 50));
        const humidityGauge = new Chart(document.getElementById('humidityGauge'), createGaugeConfig('#22C55E', 100));
        const liveHistoryChart = new Chart(document.getElementById('liveHistoryChart'), liveHistoryConfig);
        const historicalChart = new Chart(document.getElementById('historicalChart'), historicalConfig);


        // --- Connection Status Management ---
        let connectionState = 'connecting'; // 'connecting', 'connected', 'lost'

        function updateConnectionStatus(newStatus, message = '') {
            connectionState = newStatus;
            connStatusDot.classList.remove('pulse-yellow', 'bg-green-500', 'bg-red-500', 'bg-slate-400');

            switch (newStatus) {
                case 'connected':
                    connStatusText.innerText = 'Connected';
                    connStatusDot.classList.add('bg-green-500');
                    connStatusDot.title = 'Connected';
                    break;
                case 'lost':
                    connStatusText.innerText = 'Connection Lost!';
                    connStatusDot.classList.add('bg-red-500');
                    connStatusDot.title = `Connection Lost: ${message}`;
                    break;
                case 'connecting':
                default:
                    connStatusText.innerText = 'Connecting...';
                    connStatusDot.classList.add('pulse-yellow');
                    connStatusDot.title = 'Connecting...';
                    break;
            }
        }

        // --- Function to create historical sample data ---
        function updateHistoricalChart(timeRange) {
            console.log(`Generating sample data for: ${timeRange}`);
            const newLabels = [];
            const newTempData = [];
            const newHumData = [];

            // Helper to generate a random trend
            const generateTrend = (numPoints, baseVal, seasonalFactor, noise) => {
                const data = [];
                for (let i = 0; i < numPoints; i++) {
                    let seasonalEffect = Math.sin((i / (numPoints / seasonalFactor)) * Math.PI) * 8 + baseVal;
                    let randomNoise = (Math.random() - 0.5) * noise;
                    data.push(parseFloat((seasonalEffect + randomNoise).toFixed(1))); // Parse to float for chart.js
                }
                return data;
            };

            switch (timeRange) {
                case 'hour':
                    for (let i = 0; i < 60; i += 5) { newLabels.push(`-${60-i}m`); } // Labels: -60m, -55m...
                    newTempData.push(...generateTrend(12, 22, 1, 1));
                    newHumData.push(...generateTrend(12, 45, 1, 3));
                    break;
                case 'day':
                    for (let i = 0; i < 24; i += 2) { newLabels.push(`${String(i).padStart(2, '0')}:00`); } // Labels: 00:00, 02:00...
                    newTempData.push(...generateTrend(12, 20, 1, 2));
                    newHumData.push(...generateTrend(12, 50, 1, 5));
                    break;
                case 'month':
                    for (let i = 1; i <= 30; i += 3) { newLabels.push(`Day ${i}`); } // Labels: Day 1, Day 4...
                    newTempData.push(...generateTrend(10, 18, 2, 3));
                    newHumData.push(...generateTrend(10, 55, 2, 5));
                    break;
                case 'year':
                default:
                    newLabels.push('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
                    newTempData.push(...generateTrend(12, 15, 2, 2)); // Strong seasonal trend
                    newHumData.push(...generateTrend(12, 50, 1, 5));
                    break;
            }

            // Update chart data
            historicalChart.data.labels = newLabels;
            historicalChart.data.datasets[0].data = newTempData;
            historicalChart.data.datasets[1].data = newHumData;
            historicalChart.update();

            // Update active button style
            document.querySelectorAll('#chart-buttons .btn-chart').forEach(btn => {
                btn.classList.remove('btn-chart-active');
                if (btn.dataset.range === timeRange) {
                    btn.classList.add('btn-chart-active');
                }
            });
        }
        
        // Function to show toast notifications
        let toastTimer;
        function showToast(message) {
            toast.innerText = message;
            toast.classList.remove('opacity-0', 'translate-y-5');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            if (toastTimer) {
                clearTimeout(toastTimer);
            }
            
            toastTimer = setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-5');
            }, 3000);
        }

        // --- Dashboard Update Function ---
        function updateLiveDashboard(data) {
            try {
                // Since we are getting data, the connection is good
                if(connectionState !== 'connected') updateConnectionStatus('connected');

                const temp = data.temperature;
                const hum = data.humidity;
                const status = data.status;

                // 1. Update Gauges
                // We use Math.max(0, ...) to ensure the gauge fill percentage is never negative
                tempGauge.data.datasets[0].data = [temp, Math.max(0, 50 - temp)];
                tempLabel.innerText = `${temp.toFixed(1)}°C`;
                tempGauge.update('none');

                humidityGauge.data.datasets[0].data = [hum, Math.max(0, 100 - hum)];
                humLabel.innerText = `${hum.toFixed(1)}%`;
                humidityGauge.update('none');
                
                // 2. Update Status Panel (in Sidebar)
                deviceStatusDot.classList.remove('bg-slate-400', 'bg-green-500', 'pulse-red');
                deviceCardLivingRoom.classList.remove('pulse-shadow-red');

                if (status === 'alert') {
                    // Set text and ALERT styles
                    deviceStatusText.innerText = 'ALERT';
                    deviceStatusText.classList.add('text-red-600');
                    deviceStatusText.classList.remove('text-slate-600', 'text-green-600');
                    deviceStatusDot.classList.add('pulse-red'); // Make dot pulse
                    
                    // Update device card
                    deviceCardStatusText.innerText = 'ALERT';
                    deviceCardStatusText.classList.add('text-red-600');
                    deviceCardStatusText.classList.remove('text-slate-600', 'text-green-600');
                    deviceCardStatusDot.classList.add('bg-red-500');
                    deviceCardStatusDot.classList.remove('bg-slate-400', 'bg-green-500');
                    deviceCardLivingRoom.classList.add('pulse-shadow-red');
                    
                    // Enable the mute button
                    deviceCardMuteBtn.disabled = false;
                    deviceCardMuteBtn.classList.remove('hidden', 'btn-disabled');
                    
                } else if (status === 'normal') {
                    // Set text and NORMAL styles
                    deviceStatusText.innerText = 'Online';
                    deviceStatusText.classList.add('text-green-600');
                    deviceStatusText.classList.remove('text-slate-600', 'text-red-600');
                    deviceStatusDot.classList.add('bg-green-500');
                    
                    // Update device card
                    deviceCardStatusText.innerText = 'Online';
                    deviceCardStatusText.classList.add('text-green-600');
                    deviceCardStatusText.classList.remove('text-slate-600', 'text-red-600');
                    deviceCardStatusDot.classList.add('bg-green-500');
                    deviceCardStatusDot.classList.remove('bg-slate-400', 'bg-red-500');
                    
                    // Hide the mute button
                    deviceCardMuteBtn.classList.add('hidden');
                    deviceCardMuteBtn.disabled = true;
                }
                
                // Update device card live data
                deviceCardTemp.innerText = `${temp.toFixed(1)} °C`;
                deviceCardHum.innerText = `${hum.toFixed(1)} %`;

                // 3. Update Quick Stats & Gauge Min/Max
                if (temp > maxTempToday) maxTempToday = temp;
                if (temp < minTempToday) minTempToday = temp;
                if (hum > maxHumToday) maxHumToday = hum;
                if (hum < minHumToday) minHumToday = hum;

                statTempEl.innerText = `${temp.toFixed(1)}°C`;
                statHumEl.innerText = `${hum.toFixed(1)}%`;
                maxTempEl.innerText = `${maxTempToday.toFixed(1)} °C`;
                minTempEl.innerText = `${minTempToday.toFixed(1)} °C`;
                
                gaugeMaxTempEl.innerText = `${maxTempToday.toFixed(1)} °C`;
                gaugeMinTempEl.innerText = `${minTempToday.toFixed(1)} °C`;
                gaugeMaxHumEl.innerText = `${maxHumToday.toFixed(1)} %`;
                gaugeMinHumEl.innerText = `${minHumToday.toFixed(1)} %`;

                // 4. Update Live History Chart
                const now = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                liveHistoryChart.data.labels.push(now);
                liveHistoryChart.data.datasets[0].data.push(temp.toFixed(1));
                liveHistoryChart.data.datasets[1].data.push(hum.toFixed(1));

                // Limit history points
                if (liveHistoryChart.data.labels.length > MAX_LIVE_DATA_POINTS) {
                    liveHistoryChart.data.labels.shift();
                    liveHistoryChart.data.datasets[0].data.shift();
                    liveHistoryChart.data.datasets[1].data.shift();
                }
                liveHistoryChart.update('none');

            } catch (e) {
                console.error("Error updating dashboard:", e);
            }
        }
        
        // --- Event Listeners ---
        
        // Page Navigation
        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            navLinks.forEach(link => {
                link.classList.remove('nav-link-active');
                if (link.hash === `#${pageId}`) {
                    link.classList.add('nav-link-active');
                }
            });
            // Close mobile menu after navigation
            closeMobileMenu();
            setTimeout(() => lucide.createIcons(), 0);
        }

        document.getElementById('sidebar-nav').addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.classList.contains('nav-link')) {
                e.preventDefault(); 
                const pageId = link.hash.substring(1); 
                showPage(`page-${pageId}`);
            }
        });
        
        // Mobile menu toggle functions
        function openMobileMenu() {
            mobileSidebar.classList.remove('-translate-x-full');
            mobileMenuOverlay.classList.remove('hidden');
            setTimeout(() => mobileMenuOverlay.classList.add('opacity-100'), 10);
        }

        function closeMobileMenu() {
            mobileSidebar.classList.add('-translate-x-full');
            mobileMenuOverlay.classList.remove('opacity-100');
            setTimeout(() => mobileMenuOverlay.classList.add('hidden'), 300);
        }

        // Add event listeners for mobile menu buttons
        mobileMenuButtons.forEach(btn => btn.addEventListener('click', openMobileMenu));
        closeMenuBtn.addEventListener('click', closeMobileMenu);
        mobileMenuOverlay.addEventListener('click', closeMobileMenu);


        // Mute Button
        deviceCardMuteBtn.addEventListener('click', () => {
            if (deviceCardMuteBtn.disabled) return;
            console.log("Mute command sent to device!");
            
            // To send a command back to the Arduino, publish to a command topic.
            const commandTopic = MQTT_TOPIC + "/cmd";
            try {
                // The client.send function publishes the message
                client.send(commandTopic, "MUTE", 0, false);
                showToast("Mute command sent!");
            } catch (e) {
                console.error("Failed to send MUTE command:", e);
                showToast("Error sending command. Connection issue?");
            }

            // Simulate immediate mute on dashboard
            deviceCardMuteBtn.classList.add('hidden');
            deviceCardMuteBtn.disabled = true;
        });

        // Other interactive buttons
        addDeviceBtn.addEventListener('click', () => showToast("Feature coming soon!"));
        kitchenToggle.addEventListener('click', () => {
            if (kitchenToggle.checked) {
                showToast("Kitchen Smart Plug turned ON");
            } else {
                showToast("Kitchen Smart Plug turned OFF");
            }
        });


        // Chart buttons
        if (chartButtonContainer) {
            chartButtonContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-chart')) {
                    const range = e.target.dataset.range;
                    updateHistoricalChart(range);
                }
            });
        }

        // --- Settings Page Logic ---
        if (maxTempSlider) {
            // Initialize slider values and text based on current configuration
            maxTempSlider.value = MAX_TEMP;
            minTempSlider.value = MIN_TEMP;
            maxHumiSlider.value = MAX_HUMIDITY;
            maxTempVal.innerText = `${MAX_TEMP.toFixed(1)}°C`;
            minTempVal.innerText = `${MIN_TEMP.toFixed(1)}°C`;
            maxHumiVal.innerText = `${MAX_HUMIDITY.toFixed(1)}%`;
        }
        maxTempSlider?.addEventListener('input', (e) => {
            maxTempVal.innerText = `${parseFloat(e.target.value).toFixed(1)}°C`;
        });
        minTempSlider?.addEventListener('input', (e) => {
            minTempVal.innerText = `${parseFloat(e.target.value).toFixed(1)}°C`;
        });
        maxHumiSlider?.addEventListener('input', (e) => {
            maxHumiVal.innerText = `${parseFloat(e.target.value).toFixed(1)}%`;
        });

        saveSettingsBtn?.addEventListener('click', () => {
            // 1. Update local state
            MAX_TEMP = parseFloat(maxTempSlider.value);
            MIN_TEMP = parseFloat(minTempSlider.value);
            MAX_HUMIDITY = parseFloat(maxHumiSlider.value);
            
            console.log("New settings saved:", { MAX_TEMP, MIN_TEMP, MAX_HUMIDITY });

            // --- MQTT PUBLISHING LOGIC to update device thresholds (Improved Robustness) ---
            const commandTopic = MQTT_TOPIC + "/set_thresholds";
            const settingsPayload = {
                max_temp: MAX_TEMP,
                min_temp: MIN_TEMP,
                max_hum: MAX_HUMIDITY
            };
            const payloadString = JSON.stringify(settingsPayload);

            try {
                if (typeof client !== 'undefined' && client.isConnected()) {
                    // Explicitly create message object for robustness
                    const message = new Paho.MQTT.Message(payloadString);
                    message.destinationName = commandTopic;
                    message.qos = 0; // QoS 0 (fire and forget)
                    
                    client.send(message);
                    // IMPORTANT: We clarify to the user that they must wait for the device to respond.
                    showToast("Settings saved and thresholds sent to device! Waiting for device status update..."); 
                } else {
                    showToast("Settings saved locally, but device connection is lost. Cannot send thresholds.");
                    console.warn("MQTT client not connected. Could not publish thresholds.");
                }
            } catch (e) {
                console.error("Failed to send SET_THRESHOLD command:", e);
                showToast("Settings saved, but error sending command to device. Check console for details.");
            }
            // --- END IMPROVED LOGIC ---
        });
        
        toggleEmail?.addEventListener('click', () => {
            if (toggleEmail.checked) {
                showToast("Email alerts enabled!");
            } else {
                showToast("Email alerts disabled.");
            }
        });
        togglePush?.addEventListener('click', () => {
            if (togglePush.checked) {
                showToast("Push notifications enabled!");
            } else {
                showToast("Push notifications disabled.");
            }
        });
        
        // --- FIREBASE AND MQTT CONFIGURATION (UNCHANGED LOGIC) ---
        // I kept your original Firebase and MQTT setup logic exactly as you provided it.
        
        // <!-- Firebase SDK (Original includes retained) -->
        // <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"></script>
        // <!-- // <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js"></script> -->

        <!-- Firebase App (core) -->
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <!-- Firestore -->
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>


        <!-- MQTT SDK -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

        <script>
        // 1️⃣ Initialize Firebase FIRST
        const firebaseConfig = {
            apiKey: "AIzaSyDfClRcIk21FbPyvrmsuOsoVaK0ifVnXbI",
            authDomain: "temp-monitor-315d7.firebaseapp.com",
            projectId: "temp-monitor-315d7",
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // ✅ This must exist before MQTT messages

        // Optional: Firestore live listener for last 10 messages
        db.collection("sensorData")
            .orderBy("timestamp", "desc")
            .limit(10)
            .onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("📡 Cloud Data:", data);

                    // OPTIONAL: Update your dashboard UI
                    updateLiveDashboard(data);
                });
            });

        // 2️⃣ MQTT CONFIGURATION (Netlify-ready)
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884; // Secure WebSocket port
        const MQTT_PATH = "/mqtt"; // Required path
        const MQTT_TOPIC = "hope/iot_project/student181";
        const MQTT_CLIENT_ID = "web-client-" + Math.floor(Math.random() * 100000);

        // Create MQTT client
        const client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_PATH, MQTT_CLIENT_ID);

        // --- CALLBACKS ---
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // --- CONNECT FUNCTION ---
        function startConnect() {
            if (client.isConnected()) {
                console.log("⚠️ Already connected — skipping reconnect.");
                return;
            }

            updateConnectionStatus('connecting');
            console.log(`Connecting securely to wss://${MQTT_BROKER}:${MQTT_PORT}${MQTT_PATH} ...`);

            client.connect({
                onSuccess: onConnect,
                onFailure: (err) => { 
                    console.error("❌ Connection failed:", err);
                    updateConnectionStatus('lost', err.errorMessage);
                    setTimeout(startConnect, 5000);
                },
                useSSL: true
            });
        }

        // --- SUCCESS HANDLER ---
        function onConnect() {
            console.log("✅ Connected securely to HiveMQ!");
            updateConnectionStatus('connected');
            client.subscribe(MQTT_TOPIC);
            console.log("📡 Subscribed to:", MQTT_TOPIC);
        }

        // --- CONNECTION LOST HANDLER ---
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.warn("⚠️ Connection lost:", responseObject.errorMessage);
                updateConnectionStatus('lost', responseObject.errorMessage);
            }
            console.log("🔄 Reconnecting in 5s...");
            setTimeout(startConnect, 5000);
        }

        // --- MESSAGE RECEIVED HANDLER ---
        function onMessageArrived(message) {
            const payload = JSON.parse(message.payloadString);
            console.log("Incoming MQTT:", payload);

            // Save to Firestore
            db.collection("sensorData").add({
                temperature: payload.temperature,
                humidity: payload.humidity,
                status: payload.status,
                timestamp: new Date().toISOString(),
            })
            .then(() => console.log("✅ Saved to Firestore"))
            .catch(err => console.error("❌ Firestore error:", err));

            // Update dashboard UI immediately
            updateLiveDashboard(payload);
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Start the LIVE MQTT connection AFTER Firebase is ready
            startConnect(); 
            
            // Initialize the historical chart
            updateHistoricalChart('year'); 
            
            // Show the dashboard page by default
            showPage('page-dashboard');

            // Set default theme for charts
            updateChartTheme();
        });
        </script>
    </script>


</body>
</html>
